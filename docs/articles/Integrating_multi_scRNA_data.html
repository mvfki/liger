<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="rliger">
<title>Joint definition of cell types from multiple scRNA-seq datasets • rliger</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Atkinson_Hyperlegible-0.4.8/font.css" rel="stylesheet">
<!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Joint definition of cell types from multiple scRNA-seq datasets">
<meta property="og:description" content="rliger">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">rliger</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.99.1</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/installation.html">Installation</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-tutorials">Tutorials</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-tutorials">
    <a class="dropdown-item" href="../articles/Integrating_multi_scRNA_data.html">Integrating multiple scRNAseq data</a>
    <a class="dropdown-item" href="../articles/Integrating_scRNA_and_scATAC_data.html">Integrating scRNA and scATAC data</a>
    <a class="dropdown-item" href="../articles/online_iNMF_tutorial.html">Online iNMF with HDF5 based data</a>
    <a class="dropdown-item" href="../articles/UINMF_vignette.html">Integration using unshared features</a>
    <a class="dropdown-item" href="../articles/cross_species_vig.html">Cross-species Analysis with UINMF</a>
    <a class="dropdown-item" href="../articles/STARmap_dropviz_vig.html">UINMF with STARmap spatial and transcriptomic</a>
    <a class="dropdown-item" href="../articles/SNAREseq_walkthrough.html">UINMF with SNAREseq scATAC and scRNA</a>
    <a class="dropdown-item" href="../articles/rna_methylation.html">Integrating scRNAseq and DNA methylation</a>
  </div>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-usage">Usage</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-usage">
    <a class="dropdown-item" href="../articles/import_data.html">Import data</a>
    <a class="dropdown-item" href="../articles/liger_object.html">Introduction to a liger object</a>
    <a class="dropdown-item" href="../articles/liger_with_seurat.html">Interoperate with Seurat</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">NEWS</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://welch-lab.github.io/">Welch Lab</a>
</li>
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/welch-lab/liger">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
<li class="nav-item">
  <a class="external-link nav-link" href="https://twitter.com/LabWelch">
    <span class="fab fa fab fa-twitter fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Joint definition of cell types from multiple scRNA-seq datasets</h1>
                        <h4 data-toc-skip class="author">Joshua Sodicoff
and Joshua Welch</h4>
            
            <h4 data-toc-skip class="date">2023-02-27</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/welch-lab/liger/blob/HEAD/vignettes/articles/Integrating_multi_scRNA_data.rmd" class="external-link"><code>vignettes/articles/Integrating_multi_scRNA_data.rmd</code></a></small>
      <div class="d-none name"><code>Integrating_multi_scRNA_data.rmd</code></div>
    </div>

    
    
<p>This guide will demonstrate the usage of the Liger package in the
style of the R Console, which can be accessed through an R development
environment (e.g., RStudio) or directly from the R command line.</p>
<div class="section level2">
<h2 id="stage-i-preprocessing-and-normalization">Stage I: Preprocessing and Normalization<a class="anchor" aria-label="anchor" href="#stage-i-preprocessing-and-normalization"></a>
</h2>
<div class="section level3">
<h3 id="loading-data">1. Loading data<a class="anchor" aria-label="anchor" href="#loading-data"></a>
</h3>
<p>For the first portion of this protocol, we will be integrating data
from control and interferon-stimulated PBMCs from <a href="https://www.nature.com/articles/nbt.4042" class="external-link">Kang et al, 2017</a>.
The data can be found in the Gene Expression Omnibus, <a href="https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE96583" class="external-link">Series
GSE96583</a>. This dataset was originally in the form of output from the
10X Cellranger pipeline, though we will directly load downsampled
versions of the control and stimulated DGEs here.</p>
<p><strong>For convenience, we have prepared the pre-processed data
which are ready to use.</strong> There are two datasets: PBMC control
and PBMC interferon-stimulated. We provided ready-to-use liger object,
which can be easily loaded with <code><a href="../reference/importVignetteData.html">importPBMC()</a></code>.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/welch-lab/liger" class="external-link">rliger</a></span><span class="op">)</span></span>
<span><span class="va">pbmcLiger</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/importVignetteData.html">importPBMC</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>For creating a liger object from raw counts data or any other types
of source, please refer to the <a href="#">detailed tutorial for
importing data</a>.</p>
</div>
<div class="section level3">
<h3 id="preprocess">2. Preprocess<a class="anchor" aria-label="anchor" href="#preprocess"></a>
</h3>
<p>Before we can run iNMF on our datasets, we must run several
preprocessing steps to normalize expression data to account for
differences in sequencing depth and efficiency between cells, identify
variably expressed genes, and scale the data so that each gene has the
same variance. Note that because nonnegative matrix factorization
requires positive values, we do not center the data by subtracting the
mean. We also do not log transform the data.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pbmcLiger</span> <span class="op">&lt;-</span> <span class="va">pbmcLiger</span> <span class="op"><a href="https://rdrr.io/pkg/magrittr/man/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="../reference/normalize.html">normalize</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/magrittr/man/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="../reference/selectGenes.html">selectGenes</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/magrittr/man/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="../reference/scaleNotCenter.html">scaleNotCenter</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="stage-ii-integration-with-joint-matrix-factorization">Stage II: Integration with Joint Matrix Factorization<a class="anchor" aria-label="anchor" href="#stage-ii-integration-with-joint-matrix-factorization"></a>
</h2>
<div class="section level3">
<h3 id="determine-parameters-and-perform-inmf-integration">3. Determine parameters and perform iNMF integration<a class="anchor" aria-label="anchor" href="#determine-parameters-and-perform-inmf-integration"></a>
</h3>
<p>We are now able to run integrative non-negative matrix factorization
(iNMF) on the normalized and scaled datasets. The key parameter for this
analysis is <code>k</code>, the number of matrix factors (analogous to
the number of principal components in PCA). In general, we find that a
value of <code>k</code> between 20 and 40 is suitable for most analyses
and that results are robust for choice of <code>k</code>. Because LIGER
is an unsupervised, exploratory approach, there is no single “right”
value for <code>k</code>. In practice, users choose <code>k</code> from
a combination of biological prior knowledge and other information. For
this tutorial, we set <code>k = 20</code>.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pbmcLiger</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/runIntegration.html">runIntegration</a></span><span class="op">(</span><span class="va">pbmcLiger</span>, k <span class="op">=</span> <span class="fl">20</span><span class="op">)</span></span></code></pre></div>
<blockquote>
<p>Starting from rliger 2.0.0, we use an optimized implementation of
iNMF. Here we deprecated the parameter <code>thresh</code> which stands
for a convergence detecter in order to speed up each algorithm iteration
by omitting the calculation of objective error.</p>
</blockquote>
<p>The factorization yields several lower dimension matrices, including
the <span class="math inline">\(H\)</span> matrices of metagene loadings
for each cell, the <span class="math inline">\(W\)</span> matrix of
shared factor loadings and the <span class="math inline">\(V\)</span>
matrices of dataset-specific factor loadings. Please refer to <a href="#">liger object documentation</a> for how to access them.</p>
<p>The time consumption of this step is dependent of the size of the
datasets, in terms of number of cells, number of variable genes
selected, and the value of <code>k</code>. The implementation supports
OpenMP multi-threading, and there for using a machine with a number of
cores allocated helps speeding it up.</p>
</div>
</div>
<div class="section level2">
<h2 id="stage-iii-quantile-normalization-and-joint-clustering">Stage III: Quantile Normalization and Joint Clustering<a class="anchor" aria-label="anchor" href="#stage-iii-quantile-normalization-and-joint-clustering"></a>
</h2>
<div class="section level3">
<h3 id="align-the-factors">4. Align the factors<a class="anchor" aria-label="anchor" href="#align-the-factors"></a>
</h3>
<p>We can now use the resulting factors to jointly cluster cells and
perform quantile normalization by dataset, factor, and cluster to fully
integrate the datasets. All of this functionality is encapsulated within
the <code><a href="../reference/quantileNorm.html">quantileNorm()</a></code> function, which uses max factor
assignment followed by refinement using a k-nearest neighbors graph.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pbmcLiger</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/quantileNorm.html">quantileNorm</a></span><span class="op">(</span><span class="va">pbmcLiger</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="clustering">5. Clustering<a class="anchor" aria-label="anchor" href="#clustering"></a>
</h3>
<p>The <code><a href="../reference/quantileNorm.html">quantileNorm()</a></code> procedure produces joint clustering
assignments and a low-dimensional representation that integrates the
datasets together. These joint clusters directly from iNMF can be used
for downstream analyses (see below). Alternatively, you can also run
Louvain community detection, an algorithm commonly used for single-cell
data, on the normalized cell factors. The Louvain algorithm excels at
merging small clusters into broad cell classes and thus may be more
desirable in some cases than the maximum factor assignments produced
directly by iNMF.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pbmcLiger</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/runCluster.html">runCluster</a></span><span class="op">(</span><span class="va">pbmcLiger</span>, resolution <span class="op">=</span> <span class="fl">0.25</span>, nNeighbors <span class="op">=</span> <span class="fl">30</span><span class="op">)</span></span></code></pre></div>
<blockquote>
<p>Starting from rliger 2.0.0, cluster labeling will be stored in cell
metadata, which can be accessed with <code>cellMeta(pbmcLiger)</code>.
Use argument <code>clusterName</code> to specify unique variable names
for the result can enable storing multiple cluster labeling variables at
the same time.</p>
</blockquote>
</div>
</div>
<div class="section level2">
<h2 id="stage-iv-visualization-and-downstream-analysis">Stage IV: Visualization and Downstream Analysis<a class="anchor" aria-label="anchor" href="#stage-iv-visualization-and-downstream-analysis"></a>
</h2>
<div class="section level3">
<h3 id="generate-dimensionality-reduced-embedding">6. Generate dimensionality reduced embedding<a class="anchor" aria-label="anchor" href="#generate-dimensionality-reduced-embedding"></a>
</h3>
<p>To visualize the clustering of cells graphically, we can project the
normalized cell factors to two or three dimensions. LIGER supports both
UMAP and t-SNE for this purpose.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pbmcLiger</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/runUMAP.html">runUMAP</a></span><span class="op">(</span><span class="va">pbmcLiger</span>, n_neighbors <span class="op">=</span> <span class="fl">30</span>, min_dist <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span></span></code></pre></div>
<blockquote>
<p>Starting from rliger 2.0.0, the slot for storing dimensionality
reduction matrices will be renamed to “dimReds”. It will be a list that
can hold multiple low dimensional matrices that match to the dataset by
cell identifiers. Users can access individual matrix with
<code>dimRed(object, "name")</code>. Use argument
<code>dimredName</code> to specify unique names for the UMAP result so
that it allows storing multiple low-dimensional representation matrices
at the same time.</p>
</blockquote>
</div>
<div class="section level3">
<h3 id="create-plots">7. Create plots<a class="anchor" aria-label="anchor" href="#create-plots"></a>
</h3>
<p>We provide a variety of utilities for visualization and analysis of
clustering, gene expression across datasets, and comparisons of cluster
assignments. Here we demonstrate several commonly used examples.</p>
<p><code><a href="../reference/plotDimRed.html">plotByDatasetAndCluster()</a></code> returns two graphs, generated
by t-SNE or UMAP in the previous step. The first colors cells by dataset
of origin, and the second by cluster as determined by previous
clustering step. The plots provide visual confirmation that the datasets
are well aligned and the clusters are consistent with the shape of the
data as revealed by UMAP.</p>
<p>The two subplots can individually be generated with
<code><a href="../reference/plotDimRed.html">plotDatasetDimRed()</a></code> and <code><a href="../reference/plotDimRed.html">plotClusterDimRed()</a></code>,
respectively.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plotDimRed.html">plotByDatasetAndCluster</a></span><span class="op">(</span><span class="va">pbmcLiger</span><span class="op">)</span></span></code></pre></div>
<p><img src="Integrating_multi_scRNA_data_files/figure-html/4-1-1.png" width="960" style="display: block; margin: auto;"></p>
<p>To directly study the impact of factors on the clustering and
determine what genes load most highly on each factor, we use the
<code><a href="../reference/plotGeneLoadings.html">plotGeneLoadings()</a></code> function, which returns plots of factor
loading on the dimensionality reduction and highly loaded genes by
dataset for each factor.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">factorMarkers</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/getFactorMarkers.html">getFactorMarkers</a></span><span class="op">(</span><span class="va">pbmcLiger</span>, dataset1 <span class="op">=</span> <span class="st">"ctrl"</span>, dataset2 <span class="op">=</span> <span class="st">"stim"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/plotGeneLoadings.html">plotGeneLoadings</a></span><span class="op">(</span><span class="va">pbmcLiger</span>, markerTable <span class="op">=</span> <span class="va">factorMarkers</span>, useFactor <span class="op">=</span> <span class="fl">11</span><span class="op">)</span></span></code></pre></div>
<p><img src="Integrating_multi_scRNA_data_files/figure-html/unnamed-chunk-2-1.png" width="700" style="display: block; margin: auto;"></p>
</div>
<div class="section level3">
<h3 id="differential-expression">8. Differential expression<a class="anchor" aria-label="anchor" href="#differential-expression"></a>
</h3>
<p>Using the <code><a href="../reference/liger-DEG.html">runMarkerDEG()</a></code> function, we can next identify
gene markers for all clusters. We can also compare expression within
each cluster across datasets, which in this case reveals markers of
interferon-beta stimulation. The function returns a table of data that
allows us to determine the significance of each gene’s differential
expression, including log fold change, area under the curve (auc) and
p-value.</p>
<p>The default parameters performs Wilcoxon rank-sum test at a cluster
level:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cluster.results</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/liger-DEG.html">runMarkerDEG</a></span><span class="op">(</span><span class="va">pbmcLiger</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">cluster.results</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##     feature group     avgExpr        logFC statistic       auc          pval</span></span>
<span><span class="co">## 1 LINC00115     0  0.06548765 -0.006831338  19062921 0.4998240  7.853272e-01</span></span>
<span><span class="co">## 2     NOC2L     0  0.42171394 -0.918042058  17940417 0.4703922  1.451809e-33</span></span>
<span><span class="co">## 3    KLHL17     0  0.01231308 -0.009050681  19059126 0.4997245  4.088815e-01</span></span>
<span><span class="co">## 4   PLEKHN1     0  0.18786561  0.141525882  19248732 0.5046959  3.409058e-11</span></span>
<span><span class="co">## 5      HES4     0  4.77875763  3.499327819  23294848 0.6107838 3.386982e-241</span></span>
<span><span class="co">## 6     ISG15     0 13.53868172  2.108323599  25067656 0.6572663 7.671903e-185</span></span>
<span><span class="co">##            padj      pct_in    pct_out</span></span>
<span><span class="co">## 1  8.183645e-01  0.43184885  0.4662910</span></span>
<span><span class="co">## 2  1.239673e-32  2.80701754  8.5583835</span></span>
<span><span class="co">## 3  4.694960e-01  0.08097166  0.1360016</span></span>
<span><span class="co">## 4  1.313878e-10  1.24156545  0.3011463</span></span>
<span><span class="co">## 5 1.329469e-239 30.47233468  8.1212357</span></span>
<span><span class="co">## 6 2.522435e-183 71.39001350 64.4744511</span></span></code></pre>
<p>Alternatively, it is also helpful to identify dataset specific
markers within each cluster. For example in this tutorial, we can split
data by cluster labeling, and within a cluster, find the markers from
interferon-stimulated cells.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">datasets.results</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/liger-DEG.html">runMarkerDEG</a></span><span class="op">(</span><span class="va">pbmcLiger</span>, conditionBy <span class="op">=</span> <span class="st">"dataset"</span>, splitBy <span class="op">=</span> <span class="st">"leiden_cluster"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">datasets.results</span><span class="op">$</span><span class="va">`0`</span><span class="op">)</span> <span class="co"># Note that the first cluster is "0"</span></span></code></pre></div>
<pre><code><span><span class="co">##     feature group    avgExpr        logFC statistic          auc          pval</span></span>
<span><span class="co">## 1 LINC00115  ctrl 0.07166558   0.01145033 1706331.0 0.5003471841  7.481448e-01</span></span>
<span><span class="co">## 2     NOC2L  ctrl 0.66238229   0.44606115 1755645.5 0.5148076676  5.381518e-08</span></span>
<span><span class="co">## 3    KLHL17  ctrl 0.02674089   0.02674089 1708145.5 0.5008792497  6.078022e-02</span></span>
<span><span class="co">## 4   PLEKHN1  ctrl 0.09743044  -0.16761495 1686271.0 0.4944649933  2.425606e-03</span></span>
<span><span class="co">## 5      HES4  ctrl 0.18860594  -8.50750976  777066.5 0.2278590937 7.338249e-270</span></span>
<span><span class="co">## 6     ISG15  ctrl 6.06724941 -13.84775223    2253.0 0.0006606469  0.000000e+00</span></span>
<span><span class="co">##            padj     pct_in     pct_out</span></span>
<span><span class="co">## 1  8.307976e-01  0.4689332   0.4002001</span></span>
<span><span class="co">## 2  3.399928e-07  4.3962485   1.4507254</span></span>
<span><span class="co">## 3  1.222348e-01  0.1758499   0.0000000</span></span>
<span><span class="co">## 4  7.540483e-03  0.6447831   1.7508754</span></span>
<span><span class="co">## 5 1.330165e-267  1.2309496  55.4277139</span></span>
<span><span class="co">## 6  0.000000e+00 37.8663540 100.0000000</span></span></code></pre>
<p>The number of significant genes identified by
<code><a href="../reference/liger-DEG.html">runMarkerDEG()</a></code> varies and depends on the datasets used. And
the raw output of the function contains the statistics of all tested
genes in all groups (clusters). In order to pick out the top markers for
each cluster, we strongly suggest using package “dplyr”, which provides
a user-friendly interface for data table manipulation. The following
code chunk first filters the markers which are statistically and
biologically significant. For example, we filter the output by taking
markers which have padj (Benjamini-Hochberg adjusted p-value) less than
0.05 and logFC (log fold change between observations in group versus
out) larger than 3. Then for each cluster, we sort the markers primarily
by its padj value in ascending order. Given that mathematically, the
lowest padj values are rounded to 0 as they are too small, for genes
tying on this metric, we then sort the markers by logFC in descending
order. Finally, we select the top 20 markers for each cluster.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="va">cluster.results.sort</span> <span class="op">&lt;-</span> <span class="va">cluster.results</span> <span class="op"><a href="https://rdrr.io/pkg/magrittr/man/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">padj</span> <span class="op">&lt;</span> <span class="fl">0.05</span>, <span class="va">logFC</span> <span class="op">&gt;</span> <span class="fl">3</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/magrittr/man/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">group</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/magrittr/man/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">padj</span>, <span class="op">-</span><span class="va">logFC</span>, .by_group <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/magrittr/man/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/top_n.html" class="external-link">top_n</a></span><span class="op">(</span><span class="fl">20</span><span class="op">)</span><span class="co"># rank by logFC from high to low</span></span>
<span></span>
<span><span class="co"># Show the markers for cluster 3</span></span>
<span><span class="va">cluster.results.sort</span> <span class="op"><a href="https://rdrr.io/pkg/magrittr/man/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">group</span> <span class="op">==</span> <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 20 × 10</span></span></span>
<span><span class="co">## <span style="color: #949494;"># Groups:   group [1]</span></span></span>
<span><span class="co">##    feature  group avgExpr logFC statistic   auc      pval      padj pct_in</span></span>
<span><span class="co">##    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 1</span> HLA-DRA  3        17.3  8.39 14<span style="text-decoration: underline;">100</span>526. 0.799 0   <span style="color: #949494;"> </span>     0   <span style="color: #949494;"> </span>       97.7</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 2</span> CD74     3        17.9  6.98 16<span style="text-decoration: underline;">152</span>993  0.916 0   <span style="color: #949494;"> </span>     0   <span style="color: #949494;"> </span>       99  </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 3</span> HLA-DPA1 3        14.5  7.73 13<span style="text-decoration: underline;">702</span>221  0.777 1.20<span style="color: #949494;">e</span><span style="color: #BB0000;">-300</span> 8.06<span style="color: #949494;">e</span><span style="color: #BB0000;">-298</span>   87.1</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 4</span> RPS5     3        17.0  3.20 13<span style="text-decoration: underline;">758</span>954. 0.780 9.82<span style="color: #949494;">e</span><span style="color: #BB0000;">-261</span> 5.22<span style="color: #949494;">e</span><span style="color: #BB0000;">-258</span>   98.2</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 5</span> HLA-DPB1 3        13.5  6.70 13<span style="text-decoration: underline;">268</span>518. 0.752 2.85<span style="color: #949494;">e</span><span style="color: #BB0000;">-250</span> 1.35<span style="color: #949494;">e</span><span style="color: #BB0000;">-247</span>   81.1</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 6</span> HLA-DRB1 3        15.3  7.20 13<span style="text-decoration: underline;">211</span>092. 0.749 4.07<span style="color: #949494;">e</span><span style="color: #BB0000;">-230</span> 1.53<span style="color: #949494;">e</span><span style="color: #BB0000;">-227</span>   90  </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 7</span> CCR7     3        14.0  7.13 13<span style="text-decoration: underline;">007</span>309  0.737 1.68<span style="color: #949494;">e</span><span style="color: #BB0000;">-223</span> 5.63<span style="color: #949494;">e</span><span style="color: #BB0000;">-221</span>   82.9</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 8</span> RPL10A   3        16.2  3.85 12<span style="text-decoration: underline;">703</span>108  0.720 1.63<span style="color: #949494;">e</span><span style="color: #BB0000;">-163</span> 3.42<span style="color: #949494;">e</span><span style="color: #BB0000;">-161</span>   95  </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 9</span> EEF1B2   3        13.1  4.34 12<span style="text-decoration: underline;">423</span>802. 0.704 9.61<span style="color: #949494;">e</span><span style="color: #BB0000;">-151</span> 1.75<span style="color: #949494;">e</span><span style="color: #BB0000;">-148</span>   80  </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">10</span> RPLP0    3        15.5  3.55 12<span style="text-decoration: underline;">478</span>185  0.707 1.10<span style="color: #949494;">e</span><span style="color: #BB0000;">-145</span> 1.78<span style="color: #949494;">e</span><span style="color: #BB0000;">-143</span>   92.4</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">11</span> HSP90AB1 3        12.4  3.64 12<span style="text-decoration: underline;">326</span>966. 0.699 1.64<span style="color: #949494;">e</span><span style="color: #BB0000;">-143</span> 2.55<span style="color: #949494;">e</span><span style="color: #BB0000;">-141</span>   74.7</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">12</span> RPL5     3        14.5  4.01 12<span style="text-decoration: underline;">303</span>018. 0.698 4.56<span style="color: #949494;">e</span><span style="color: #BB0000;">-135</span> 6.39<span style="color: #949494;">e</span><span style="color: #BB0000;">-133</span>   87.2</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">13</span> RPSA     3        14.8  3.95 12<span style="text-decoration: underline;">264</span>988. 0.695 2.63<span style="color: #949494;">e</span><span style="color: #BB0000;">-131</span> 3.46<span style="color: #949494;">e</span><span style="color: #BB0000;">-129</span>   89  </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">14</span> CXCR4    3        12.9  3.79 12<span style="text-decoration: underline;">112</span>580. 0.687 4.18<span style="color: #949494;">e</span><span style="color: #BB0000;">-126</span> 4.98<span style="color: #949494;">e</span><span style="color: #BB0000;">-124</span>   76  </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">15</span> RPL7A    3        14.9  3.02 12<span style="text-decoration: underline;">189</span>771  0.691 5.58<span style="color: #949494;">e</span><span style="color: #BB0000;">-124</span> 6.35<span style="color: #949494;">e</span><span style="color: #BB0000;">-122</span>   89.6</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">16</span> RAN      3        10.9  3.43 11<span style="text-decoration: underline;">846</span>094. 0.672 1.83<span style="color: #949494;">e</span><span style="color: #BB0000;">-113</span> 1.82<span style="color: #949494;">e</span><span style="color: #BB0000;">-111</span>   66.6</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">17</span> RPL4     3        13.8  3.25 11<span style="text-decoration: underline;">916</span>704. 0.676 3.40<span style="color: #949494;">e</span><span style="color: #BB0000;">-107</span> 2.93<span style="color: #949494;">e</span><span style="color: #BB0000;">-105</span>   83.3</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">18</span> NPM1     3        12.2  3.75 11<span style="text-decoration: underline;">808</span>654. 0.669 3.96<span style="color: #949494;">e</span><span style="color: #BB0000;">-106</span> 3.34<span style="color: #949494;">e</span><span style="color: #BB0000;">-104</span>   73.6</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">19</span> CREM     3        10.1  3.36 11<span style="text-decoration: underline;">180</span>874. 0.634 1.56<span style="color: #949494;">e</span><span style="color: #BB0000;">- 73</span> 8.82<span style="color: #949494;">e</span><span style="color: #BB0000;">- 72</span>   61.6</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">20</span> GLTSCR2  3        10.2  3.24 11<span style="text-decoration: underline;">121</span>632  0.631 1.34<span style="color: #949494;">e</span><span style="color: #BB0000;">- 68</span> 6.96<span style="color: #949494;">e</span><span style="color: #BB0000;">- 67</span>   63.3</span></span>
<span><span class="co">## <span style="color: #949494;"># ℹ 1 more variable: pct_out &lt;dbl&gt;</span></span></span></code></pre>
<p>We can then visualize the expression profiles of individual genes,
such as the differentially expressed genes that we just identified. This
allows us to visually confirm the cluster- or dataset-specific
expression patterns of marker genes. <code><a href="../reference/plotDimRed.html">plotGeneDimRed()</a></code>
returns graphs of gene loading on the dimensionality reduced graph for
each dataset.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plotDimRed.html">plotGeneDimRed</a></span><span class="op">(</span><span class="va">pbmcLiger</span>, <span class="st">"PRF1"</span><span class="op">)</span></span></code></pre></div>
<p><img src="Integrating_multi_scRNA_data_files/figure-html/unnamed-chunk-4-1.png" width="576" style="display: block; margin: auto;"></p>
<p>We can also plot the gene expression by dataset.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">prf1List</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/plotDimRed.html">plotGeneDimRed</a></span><span class="op">(</span><span class="va">pbmcLiger</span>, <span class="st">"PRF1"</span>, splitBy <span class="op">=</span> <span class="st">"dataset"</span><span class="op">)</span></span>
<span><span class="fu">cowplot</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/cowplot/man/plot_grid.html" class="external-link">plot_grid</a></span><span class="op">(</span>plotlist <span class="op">=</span> <span class="va">prf1List</span>, labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">prf1List</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="Integrating_multi_scRNA_data_files/figure-html/unnamed-chunk-5-1.png" width="960" style="display: block; margin: auto;"></p>
<p>We can also use <code><a href="../reference/plotDimRed.html">plotGeneDimRed()</a></code> to compare the loading
of cluster markers within and between datasets.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">IFIT3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/plotDimRed.html">plotGeneDimRed</a></span><span class="op">(</span><span class="va">pbmcLiger</span>, <span class="st">"IFIT3"</span>, splitBy <span class="op">=</span> <span class="st">"dataset"</span><span class="op">)</span></span>
<span><span class="va">IFITM3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/plotDimRed.html">plotGeneDimRed</a></span><span class="op">(</span><span class="va">pbmcLiger</span>, <span class="st">"IFITM3"</span>, splitBy <span class="op">=</span> <span class="st">"dataset"</span><span class="op">)</span></span>
<span><span class="fu">cowplot</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/cowplot/man/plot_grid.html" class="external-link">plot_grid</a></span><span class="op">(</span><span class="va">IFIT3</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, <span class="va">IFIT3</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span>, <span class="va">IFITM3</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, <span class="va">IFITM3</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span>, ncol <span class="op">=</span> <span class="fl">2</span>, labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"ctrl"</span>, <span class="st">"stim"</span>, <span class="st">"ctrl"</span>, <span class="st">"stim"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="Integrating_multi_scRNA_data_files/figure-html/unnamed-chunk-6-1.png" width="864" style="display: block; margin: auto;"></p>
</div>
</div>
<div class="section level2">
<h2 id="r-session-info">R Session Info<a class="anchor" aria-label="anchor" href="#r-session-info"></a>
</h2>
<pre><code><span><span class="co">## R version 4.3.2 RC (2023-10-30 r85440)</span></span>
<span><span class="co">## Platform: aarch64-apple-darwin20 (64-bit)</span></span>
<span><span class="co">## Running under: macOS Sonoma 14.4</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Matrix products: default</span></span>
<span><span class="co">## BLAS:   /Library/Frameworks/R.framework/Versions/4.3-arm64/Resources/lib/libRblas.0.dylib </span></span>
<span><span class="co">## LAPACK: /Library/Frameworks/R.framework/Versions/4.3-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.11.0</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## locale:</span></span>
<span><span class="co">## [1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## time zone: America/Detroit</span></span>
<span><span class="co">## tzcode source: internal</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## attached base packages:</span></span>
<span><span class="co">## [1] stats     graphics  grDevices utils     datasets  methods   base     </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## other attached packages:</span></span>
<span><span class="co">## [1] dplyr_1.1.4   rliger_1.99.1</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## loaded via a namespace (and not attached):</span></span>
<span><span class="co">##  [1] sass_0.4.8          utf8_1.2.4          generics_0.1.3     </span></span>
<span><span class="co">##  [4] stringi_1.8.3       lattice_0.22-5      digest_0.6.34      </span></span>
<span><span class="co">##  [7] magrittr_2.0.3      evaluate_0.23       grid_4.3.2         </span></span>
<span><span class="co">## [10] fastmap_1.1.1       jsonlite_1.8.8      Matrix_1.6-5       </span></span>
<span><span class="co">## [13] ggrepel_0.9.5       scattermore_1.2     purrr_1.0.2        </span></span>
<span><span class="co">## [16] fansi_1.0.6         viridisLite_0.4.2   scales_1.3.0       </span></span>
<span><span class="co">## [19] codetools_0.2-19    textshaping_0.3.7   jquerylib_0.1.4    </span></span>
<span><span class="co">## [22] cli_3.6.2           rlang_1.1.3         RcppAnnoy_0.0.22   </span></span>
<span><span class="co">## [25] uwot_0.1.16         cowplot_1.1.3       munsell_0.5.0      </span></span>
<span><span class="co">## [28] withr_3.0.0         RANN_2.6.1          cachem_1.0.8       </span></span>
<span><span class="co">## [31] yaml_2.3.8          parallel_4.3.2      tools_4.3.2        </span></span>
<span><span class="co">## [34] memoise_2.0.1       colorspace_2.1-0    ggplot2_3.4.4      </span></span>
<span><span class="co">## [37] sccore_1.0.4        BiocGenerics_0.48.1 vctrs_0.6.5        </span></span>
<span><span class="co">## [40] R6_2.5.1            stats4_4.3.2        lifecycle_1.0.4    </span></span>
<span><span class="co">## [43] stringr_1.5.1       S4Vectors_0.40.2    fs_1.6.3           </span></span>
<span><span class="co">## [46] irlba_2.3.5.1       ragg_1.2.7          leidenAlg_1.1.2    </span></span>
<span><span class="co">## [49] pkgconfig_2.0.3     desc_1.4.3          pkgdown_2.0.7      </span></span>
<span><span class="co">## [52] bslib_0.6.1         pillar_1.9.0        gtable_0.3.4       </span></span>
<span><span class="co">## [55] glue_1.7.0          Rcpp_1.0.12         systemfonts_1.0.5  </span></span>
<span><span class="co">## [58] highr_0.10          xfun_0.41           tibble_3.2.1       </span></span>
<span><span class="co">## [61] tidyselect_1.2.0    rstudioapi_0.15.0   knitr_1.45         </span></span>
<span><span class="co">## [64] farver_2.1.1        igraph_2.0.1.1      htmltools_0.5.7    </span></span>
<span><span class="co">## [67] labeling_0.4.3      rmarkdown_2.25      RcppPlanc_1.0.0    </span></span>
<span><span class="co">## [70] compiler_4.3.2</span></span></code></pre>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Joshua Welch, Yichen Wang, Chao Gao, Jialin Liu, Joshua Sodicoff, Velina Kozareva, Evan Macosko.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
